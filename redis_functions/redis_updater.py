from redis import Redis
from rq import Queue
import datetime
import pytz
import random
import threading
import requests
from requests.exceptions import Timeout, ProxyError, TooManyRedirects


from models import Flipkart, Amazon, User

from redis_functions.redis_amazon import update_amazon
from redis_functions.redis_flipkart import update_flipkart

redis_connection = Redis(host="pearlfish.redistogo.com", port=10453,
                         password="6b7025eac8f3f18072d7496c96d8e8c5", username="redistogo")


class Time:
    def __init__(self):
        self.last_time = datetime.datetime.now(
            tz=pytz.timezone('Asia/Kolkata'))

    def get_time(self):
        random_seconds = random.randint(1, 4)
        print("Random seconds: ", random_seconds)
        Timedelta = datetime.timedelta(seconds=random_seconds)
        new_time = self.last_time + Timedelta
        self.last_time = new_time
        print("Job scheduled at: ", new_time)

        return new_time


def update_db():
    global redis_connection
    q = Queue('scrapper', connection=redis_connection)

    time = Time()
    products = Amazon.query.all()

    for product in products:
        product_id = product.product_id

        job = q.enqueue_at(time.get_time(), update_amazon, product_id)
        print("Created Amazon Job: ", job.id)

    products = Flipkart.query.all()

    for product in products:
        product_id = product.product_id

        job = q.enqueue_at(time.get_time(), update_flipkart, product_id)
        print("Created Flipkart Job: ", job.id)
